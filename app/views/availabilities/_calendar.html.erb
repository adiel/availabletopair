<% content_for :head_links do %>
    <script type="text/javascript" src="/javascripts/jquery-1.3.2.min.js"></script>
    <script type="text/javascript" src="/javascripts/jquery-ui-1.7.2.custom.min.js"></script>
    <script type="text/javascript" src="/calendarflow/ui.calendarflow.js"></script>
    <script type="text/javascript" src="/javascripts/jquery.qtip-1.0.0-rc3.min.js"></script>
    <link rel="stylesheet" type="text/css" href="/calendarflow/calendarflow.css?1" />
    <%= stylesheet_link_tag 'jquery-ui-1.7.2.custom' %>

<% end %>
<div id="calendarInstructions">You can pick up and drag this calendar (like a map)</div>
<div id="eventsCalendar" style="width:100%;height:100%;"></div>
<script type="text/javascript">

    $(document).ready(function(){
        Date.prototype.format=function(format){var returnStr='';var replace=Date.replaceChars;for(var i=0;i<format.length;i++){var curChar=format.charAt(i);if(replace[curChar]){returnStr+=replace[curChar].call(this);}else{returnStr+=curChar;}}return returnStr;};Date.replaceChars={shortMonths:['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],longMonths:['January','February','March','April','May','June','July','August','September','October','November','December'],shortDays:['Sun','Mon','Tue','Wed','Thu','Fri','Sat'],longDays:['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'],d:function(){return(this.getDate()<10?'0':'')+this.getDate();},D:function(){return Date.replaceChars.shortDays[this.getDay()];},j:function(){return this.getDate();},l:function(){return Date.replaceChars.longDays[this.getDay()];},N:function(){return this.getDay()+1;},S:function(){return(this.getDate()%10==1&&this.getDate()!=11?'st':(this.getDate()%10==2&&this.getDate()!=12?'nd':(this.getDate()%10==3&&this.getDate()!=13?'rd':'th')));},w:function(){return this.getDay();},z:function(){return"Not Yet Supported";},W:function(){return"Not Yet Supported";},F:function(){return Date.replaceChars.longMonths[this.getMonth()];},m:function(){return(this.getMonth()<9?'0':'')+(this.getMonth()+1);},M:function(){return Date.replaceChars.shortMonths[this.getMonth()];},n:function(){return this.getMonth()+1;},t:function(){return"Not Yet Supported";},L:function(){return"Not Yet Supported";},o:function(){return"Not Supported";},Y:function(){return this.getFullYear();},y:function(){return(''+this.getFullYear()).substr(2);},a:function(){return this.getHours()<12?'am':'pm';},A:function(){return this.getHours()<12?'AM':'PM';},B:function(){return"Not Yet Supported";},g:function(){return this.getHours()%12||12;},G:function(){return this.getHours();},h:function(){return((this.getHours()%12||12)<10?'0':'')+(this.getHours()%12||12);},H:function(){return(this.getHours()<10?'0':'')+this.getHours();},i:function(){return(this.getMinutes()<10?'0':'')+this.getMinutes();},s:function(){return(this.getSeconds()<10?'0':'')+this.getSeconds();},e:function(){return"Not Yet Supported";},I:function(){return"Not Supported";},O:function(){return(-this.getTimezoneOffset()<0?'-':'+')+(Math.abs(this.getTimezoneOffset()/60)<10?'0':'')+(Math.abs(this.getTimezoneOffset()/60))+'00';},T:function(){var m=this.getMonth();this.setMonth(0);var result=this.toTimeString().replace(/^.+ \(?([^\)]+)\)?$/,'$1');this.setMonth(m);return result;},Z:function(){return-this.getTimezoneOffset()*60;},c:function(){return"Not Yet Supported";},r:function(){return this.toString();},U:function(){return this.getTime()/1000;}};
        
        $("table.availabilities").hide();

        var formatTags = function (availability) {
            var html = [];
            $.each(availability.tags,function(index) {
                html += "<a href=\"/tags/" + escape(this.tag) + "\">" + this.tag + "</a>";
                if (index < availability.tags.length - 1) {
                    html += ', ';
                }
            });
            return html;
        };

        var formatPairs = function (availability) {
            return availability.pairs.length == 0 ? "No" : "Yes (" + availability.pairs.length + ")";
        };

        var convertAvailabilitiesToEvents = function(availabilities) {
            var events = [];
            $.each(availabilities, function() {
                this.availability.title = this.availability.user.username + ' is available to pair';
                this.availability.summary = '<p>On: <span>' + ((this.availability.project) ? this.availability.project : "anything") + '</span></p>' +
                                            '<p>Tags: <span> ' + formatTags(this.availability) + '</span></p>' +
                                            '<p>Pairs: <span>' + formatPairs(this.availability) + '</span></p>' +
                                            '<p><a href="/availabilities/' + this.availability.id + '/edit">Edit</a></p';
                events.push({"event":this.availability});
            });
            return events;
        };

        var buildJsonUrl = function (fromDate,toDate) {

            return (document.location.href.match(/\/$/) ? document.location.href + "availabilities" : document.location.href) +
                   ".js?from_date=" + fromDate.format('Y-m-d') + "&to_date=" + toDate.format('Y-m-d');
        };

        var findEvents = function(fromDate,toDate,context) {

             $.getJSON(buildJsonUrl(fromDate,toDate),
               function(data){
                   var events = convertAvailabilitiesToEvents(data);
                   if (events.length > 0) {
                    jQuery.calendarFlow.renderEvents(events,context);
                   }
               }
            );

        };

        $("#eventsCalendar").calendarFlow({
            "dayHeight": 720,
            "dayWidth": 200,
            "findEventsCallback": findEvents
        });

        var resizeCalendar = function() {
            $("#eventsCalendar").css("height", ($(window).height() - $("#eventsCalendar").position().top - 100) + "px");
        };

        var resizeTimer = null;
        $(window).bind('resize', function() {
            if (resizeTimer) clearTimeout(resizeTimer);
            resizeTimer = setTimeout(resizeCalendar, 100);
        });

        resizeCalendar();
    });

</script>