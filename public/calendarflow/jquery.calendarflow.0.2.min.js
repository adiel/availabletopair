(function(a){jQuery.calendarFlow={};jQuery.calendarFlow.datetime={dayName:function(b){switch(b.getUTCDay()){case (0):return"Sun";case (1):return"Mon";case (2):return"Tue";case (3):return"Wed";case (4):return"Thu";case (5):return"Fri";case (6):return"Sat"}},getMinutesThroughTheDay:function(b){return(b.getUTCHours()*60)+b.getUTCMinutes()},addDays:function(d,c){var b=new Date(d);b.setDate(d.getDate()+c);return b},addMins:function(d,c){var b=new Date(d);b.setMinutes(d.getMinutes()+c);return b},setTimeToMidnight:function(b){b.setHours(0);b.setMinutes(0);b.setSeconds(0)},formatDateForClassName:function(b){return b.getUTCFullYear()+"-"+b.getUTCMonth()+"-"+b.getUTCDate()},formatDateForDisplay:function(b){return b.toUTCString()},dayClass:function(b){return"cal-flow-"+this.dayName(b).toLowerCase()},dateOnly:function(b){return b.toString().replace(/[0-9][0-9]:[0-9][0-9]:[0-9][0-9]/,"").replace(/\+[0-9][0-9][0-9][0-9]/,"").replace(/\(.*\)/,"").replace(/GMT|UTC/,"")}};jQuery.calendarFlow.positioning={getCSSTop:function(b){return b.css("top").replace(/px/,"")},tooFarLeft:function(c,b,d){return((c.offset().left-b.offset().left)<(-1*d))},tooFarRight:function(d,b,e){var c=b.width();return(d.offset().left>c+e)},tooHigh:function(c,e){var d=this.getCSSTop(a(".cal-flow-events",c));var f=(c.height()/2);var b=-e;return d>b+f},tooLow:function(b,d){var c=this.getCSSTop(a(".cal-flow-events",b));var e=(b.height()/2);var f=(-d*2);return c<f+e}};jQuery.calendarFlow.eventRenderer={datetime:jQuery.calendarFlow.datetime,eventSummary:function(b){return b.title+" from "+this.datetime.formatDateForDisplay(b.start_time)+" - "+this.datetime.formatDateForDisplay(b.end_time)},updateDayTotal:function(e,c,g){var d=a(".cal-flow-dayHeader_"+this.datetime.formatDateForClassName(e.start_time),c);var b=a("span",d);var f=Number(b.text())+g;b.text(f);if(f>0){d.css("font-weight","bold")}},removeExistingEvent:function(e,c,b){var d=a("."+this.buildEventClassName(e,c),b);d.remove();if(d.length>0&&c===0){this.updateDayTotal(e,b,-1)}},plotEventStartTime:function(d,b,c){var e=Math.floor(this.datetime.getMinutesThroughTheDay(d)*(c/1440))+c;return e-(b*c)},getEventLengthMins:function(d,c){var b=this.datetime.getMinutesThroughTheDay(c)-this.datetime.getMinutesThroughTheDay(d);if(b<0){b+=1440}return b},buildEventClassName:function(c,b){return"cal-flow-event_"+b+"_"+c.id},isOverflowing:function(c){var b=c.style.overflow;if(!b||b==="visible"){c.style.overflow="hidden"}var d=c.clientWidth<c.scrollWidth||c.clientHeight<c.scrollHeight;c.style.overflow=b;return d},buildEventElement:function(d,n,g,l,m,b,j,i){var k=a("<div/>");k.attr("class","cal-flow-event "+this.buildEventClassName(d,n));var e=Math.floor(i/b);var f=(e*j);k.css({position:"absolute",top:l+"px",left:f+"px",height:m+"px",width:(e-1)+"px"});var h=a("<h3/>");h.html(d.title);k.append(h);var c=a('<div class="cal-flow-summary">');c.html(d.summary);k.append(c);return k},addEventTooltip:function(b){if(this.isOverflowing(b[0])){b.qtip({content:b.html(),position:{target:"mouse",adjust:{x:-50,y:-50}},hide:{fixed:true},style:{padding:"0"}})}},dropEvent:function(d,m,g,k,i,b,f){var e=m.position();var h=Math.floor((e.left-g.left)/k);var l=Math.floor(((e.top-g.top)/i)*1440);var c=this.datetime.addDays(d.start_time,h);d.start_time=this.datetime.addMins(c,l);var j=this.datetime.addDays(d.end_time,h);d.end_time=this.datetime.addMins(j,l);this.renderEvents([{event:d}],b,i,k,f);f(d)},makeEventDraggable:function(b,j,i,g,c,e){var f=j.position();var d=b;var h=this;j.draggable({grid:[i,Math.floor((g/1440)*30)],stop:function(k,l){h.dropEvent(d,j,f,i,g,c,e)},cursor:"move"})},renderEvent:function(b,q,c,h,j,p,f){this.removeExistingEvent(b,q,c);var i=this;var n=0;var k=0;a.each(p,function(r){if(this.start_time<b.end_time&&this.end_time>b.start_time){n++;if(this.id==b.id){k=n-1}}});var d=b.start_time;var g=b.end_time;d=this.datetime.addDays(d,q);var m=this.plotEventStartTime(d,q,h);var o=Math.floor(this.getEventLengthMins(d,g)*(h/1440));var e=a(".cal-flow-dayEvents_"+this.datetime.formatDateForClassName(d),c);var l=this.buildEventElement(b,q,e,m,o,n,k,j);e.prepend(l);this.addEventTooltip(l)},saveEvents:function(b){this.events=this.events||{};var c=this;a.each(b,function(){c.events[this.event.id]=this.event})},renderEvents:function(d,b,c,f,g){this.saveEvents(d);var e=this;jQuery.each(d,function(){e.renderEvent(this.event,-1,b,c,f,e.events,g);e.renderEvent(this.event,0,b,c,f,e.events,g);e.renderEvent(this.event,1,b,c,f,e.events,g);e.renderEvent(this.event,2,b,c,f,e.events,g);e.updateDayTotal(this.event,b,1)})}};jQuery.calendarFlow.Calendar=function(b,c){this.container=b;this.settings=c;this.dayHeightOptions=[336,720,1440];this.visibleEventsReloadTimeoutMS=60000;this.datetime=jQuery.calendarFlow.datetime;this.positioning=jQuery.calendarFlow.positioning;this.eventRenderer=jQuery.calendarFlow.eventRenderer;this.renderEvents=function(d){this.eventRenderer.renderEvents(d,this.container,this.settings.dayHeight,this.settings.dayWidth,this.settings.moveEventCallback)};this.loadEventsRange=function(e,d){this.settings.findEventsCallback(e,d,this)};this.newDayHeader=function(e){var d=e.getDate();if(this.settings.dayWidth>30){d=(e.getMonth()+1)+"/"+d;if(this.settings.dayWidth>70){d=e.toString().substring(0,3)+" "+d;if(this.settings.dayWidth>150){d=this.datetime.dateOnly(e)}}}var f=a('<div class="cal-flow-dayHeader  cal-flow-dayHeader_'+this.datetime.formatDateForClassName(e)+" "+this.datetime.dayClass(e)+'"><abbr title="'+this.datetime.dateOnly(e)+'">'+d+"</abbr> (<span>0</span>)</div>");f.css("width",this.settings.dayWidth+"px");return f};this.newDayEvents=function(e){var g=a('<div class="cal-flow-day '+this.datetime.dayClass(e)+" cal-flow-dayEvents_"+this.datetime.formatDateForClassName(e)+" cal-flow-date_"+e.getUTCDate()+'"></div>');g.css("width",(this.settings.dayWidth-1)+"px");var d=Math.floor(this.settings.dayHeight/24);var f={height:this.settings.dayHeight+"px","background-image":"url(/calendarflow/events_bg_"+d+".gif)"};a('<div class="cal-flow-prevDay"/>').css(f).appendTo(g);a('<div class="cal-flow-currentDay"/>').css(f).appendTo(g);a('<div class="cal-flow-nextDay"/>').css(f).appendTo(g);return g};this.readDateFromDayHeader=function(f){var d=Date.parse(a("abbr",f).attr("title"));var e=new Date(d);this.datetime.setTimeToMidnight(e);e.setMinutes(e.getMinutes()-e.getTimezoneOffset());return e};this.readHoursFromTimeHeader=function(d){return Number(a(d).text().substring(0,2))};this.readMinsFromTimeHeader=function(d){return Number(a(d).text().substring(3,5))};this.readOffsetFromTimeHeader=function(d){if(a(d).hasClass("offset_-1")){return -1}else{if(a(d).hasClass("offset_1")){return 1}else{return 0}}};this.positionNextDayElements=function(d,e,g){var h=Number(d.css("left").replace(/px/,""));var f=(h+this.settings.dayWidth)+"px";a(e).css("left",f);a(g).css("left",f)};this.positionPreviousDayElements=function(h,d,f){var g=Number(h.css("left").replace(/px/,""));var e=(g-this.settings.dayWidth)+"px";a(d).css("left",e);a(f).css("left",e)};this.newDayAhead=function(k,d,j,e){k.remove();d.remove();var g=this.readDateFromDayHeader(j);var i=this.datetime.addDays(g,1);var f=this.newDayHeader(i).appendTo(a(".cal-flow-dayHeaders",this.container));var h=this.newDayEvents(i).appendTo(a(".cal-flow-events",this.container));this.positionNextDayElements(e,f,h);return i};this.newDayBehind=function(k,d,i,e){e.remove();i.remove();var j=this.readDateFromDayHeader(d);var g=this.datetime.addDays(j,-1);var f=this.newDayHeader(g).prependTo(a(".cal-flow-dayHeaders",this.container));var h=this.newDayEvents(g).prependTo(a(".cal-flow-events",this.container));this.positionPreviousDayElements(k,f,h);return g};this.drawInitialDays=function(){var d,i,f,k,h,g,l;var j=Math.floor(this.settings.preLoadSize/this.settings.dayWidth)-2;var m=Math.floor(((this.container.width()/2)/this.settings.dayWidth))-1;var e=this.datetime.addDays(this.currentPosition,-m);d=0-j;do{i=this.datetime.setTimeToMidnight(new Date(e));i=this.datetime.addDays(e,d);g=g||i;l=i;f=this.newDayHeader(i);k=this.newDayEvents(i);h=(this.settings.dayWidth*d)+"px";a(f).css("left",h);a(k).css("left",h);f.appendTo(a(".cal-flow-dayHeaders",this.container));k.appendTo(a(".cal-flow-events",this.container));d++}while(!this.positioning.tooFarLeft(k,this.container,this.settings.preLoadSize)&&!this.positioning.tooFarRight(k,this.container,this.settings.preLoadSize));this.loadEventsRange(g,l)};this.drawExtraDays=function(l,f){var h=this;var m=a(".cal-flow-events .cal-flow-day",this.container);var i=a(".cal-flow-dayHeaders .cal-flow-dayHeader",this.container);var d=a(m[0]);var k=a(m[m.length-1]);var e=a(i[0]);var g=a(i[i.length-1]);window.clearTimeout(this.redrawDaysTimeout);if(this.positioning.tooFarLeft(d,this.container,this.settings.preLoadSize)){var j=this.newDayAhead(d,e,g,k);l=l||j;f=j;window.setTimeout(function(){h.drawExtraDays(l,f)},10);return}else{if(this.positioning.tooFarRight(k,this.container,this.settings.preLoadSize)){var n=this.newDayBehind(d,e,g,k);f=f||n;l=n;window.setTimeout(function(){h.drawExtraDays(l,f)},10);return}}if(l&&f){this.loadEventsRange(l,f)}};this.drawTimeline=function(){var f,d;for(f=0;f<72;f++){var e=Math.floor(this.settings.dayHeight/24);if(e<15){if(f%2!==0){continue}else{e*=2}}d=(f%24);if(d<10){d=("0"+d)}var g="offset_"+(((f-d)/24)-1);var h=a('<div class="cal-flow-time '+g+'">'+d+":00</div>");h.css({height:e});a(".cal-flow-timeline",this.container).append(h)}};this.buildWidthScaleControl=function(){var d=this;var e=a("<div/>");e.slider({min:35,max:1000,value:this.settings.dayWidth,change:function(f,g){window.clearTimeout(d.setDayWidthTimeout);d.setDayWidthTimeout=window.setTimeout(function(){d.setDayWidth(Number(g.value),d.container)},500)}});return e};this.buildHeightScaleControl=function(){var e=this;var d=a("<div/>");d.slider({orientation:"vertical",step:1,min:0,max:2,value:a.inArray(this.settings.dayHeight,this.dayHeightOptions),change:function(f,g){window.clearTimeout(e.setDayHeightTimeout);e.setDayHeightTimeout=window.setTimeout(function(){e.setDayHeight(e.dayHeightOptions[Number(g.value)],e.container)},500)}});return d};this.wrapSlider=function(d){return a('<div class="cal-flow-controls"/>').append(d)};this.buildScaleControls=function(){var e=this.buildWidthScaleControl(this.container);var d=this.buildHeightScaleControl(this.container);return a([this.wrapSlider(e),this.wrapSlider(d)])};this.setScale=function(){a(".cal-flow-calendarEventsWrapper",this.container).css({top:"-"+((this.settings.dayHeight*3)+20)+"px"});a(".cal-flow-timeline, .cal-flow-events",this.container).css({height:(this.settings.dayHeight*3)+"px",top:"-"+(this.settings.dayHeight-20)+"px"})};this.repositionScaleControls=function(){a(".cal-flow-controls").css("top",(this.container.height()-120)+"px");a(".cal-flow-controls").css("display","block")};this.drawInnerContainers=function(){a(".cal-flow-daysWrapper,.cal-flow-timelineWrapper,.cal-flow-calendarEventsWrapper").remove();a('<div class="cal-flow-daysWrapper">    <div class="cal-flow-dayHeaders"></div></div><div class="cal-flow-timelineWrapper">   <div class="cal-flow-timeline"></div></div><div class="cal-flow-calendarEventsWrapper">    <div class="cal-flow-events"></div></div>').appendTo(this.container)};this.focusCurrentTime=function(){var d=-1*(this.settings.dayHeight+(this.settings.dayHeight*((new Date().getHours()-3)/24)));a(".cal-flow-events",this.container).css("top",d+"px");this.syncAxes()};this.refocusCurrentDay=function(){var d=a(".cal-flow-events",this.container);var f=Number(d.css("top").replace(/px/,""));var e=Number(d.css("left").replace(/px/,""));if(this.positioning.tooHigh(this.container,this.settings.dayHeight)){d.css("left",e+this.settings.dayWidth+"px");d.css("top",f-this.settings.dayHeight+"px");this.syncAxes()}else{if(this.positioning.tooLow(this.container,this.settings.dayHeight)){d.css("left",e-this.settings.dayWidth+"px");d.css("top",f+this.settings.dayHeight+"px");this.syncAxes()}}};this.syncAxes=function(){var e=Number(a(".cal-flow-events",this.container).css("top").replace(/px/,""));var d=Number(a(".cal-flow-events",this.container).css("left").replace(/px/,""));a(".cal-flow-timeline",this.container).css("top",e+"px");a(".cal-flow-dayHeaders",this.container).css("left",d+"px")};this.dragged=function(d,e){this.syncAxes()};this.updateCurrentPosition=function(){this.currentPosition=this.findCurrentPosition()};this.stopped=function(d,e){this.drawExtraDays();this.refocusCurrentDay();this.syncAxes();this.updateCurrentPosition()};this.activateDraggable=function(){var d=this;a(".cal-flow-events",this.container).draggable({drag:function(e,f){d.dragged(e,f)},stop:function(e,f){d.stopped(e,f)},cursor:"move"})};this.addRootClass=function(){this.container.addClass("cal-flow")};this.findCurrentPosition=function(){var g,e;var i=this;a(".cal-flow-dayHeader",this.container).each(function(){var l=(a(this).offset().left-i.container.offset().left);var k=i.container.width()/2;if(l<k&&(l+i.settings.dayWidth)>k){g=this;return false}});a(".cal-flow-time",this.container).each(function(){var l=(a(this).offset().top-i.container.offset().top);var k=i.container.height()/2;if(l<k&(l+i.settings.dayHeight)>k){e=this;return false}});var f=this.readDateFromDayHeader(g);var j=this.readOffsetFromTimeHeader(e);f=this.datetime.addDays(f,j);var d=this.readHoursFromTimeHeader(e);var h=this.readMinsFromTimeHeader(e);f.setHours(d,h);return f};this.setDayWidth=function(d){if(this.settings.dayWidth!=d){this.settings.dayWidth=d;this.reset()}};this.setDayHeight=function(d){if(this.settings.dayHeight!=d){this.settings.dayHeight=d;this.reset()}};this.startVisibleEventsReloadTimeout=function(){var d=this;this.visibleEventsReloadTimeout=window.setTimeout(function(){var f=a(".cal-flow-dayHeaders .cal-flow-dayHeader",this.container);var e=a(f[0]);var g=a(f[f.length-1]);var i=d.readDateFromDayHeader(e);var h=d.readDateFromDayHeader(g);d.loadEventsRange(i,h);d.startVisibleEventsReloadTimeout()},this.visibleEventsReloadTimeoutMS)};this.reset=function(){window.clearTimeout(this.visibleEventsReloadTimeout);this.addRootClass();this.drawInnerContainers();this.setScale();this.drawTimeline();this.drawInitialDays();this.updateCurrentPosition();this.focusCurrentTime();this.activateDraggable();this.repositionScaleControls();this.startVisibleEventsReloadTimeout()};this.init=function(){if(this.container.length===0){return}this.currentPosition=this.currentPosition||new Date();this.datetime.setTimeToMidnight(this.currentPosition);this.reset();this.buildScaleControls(this.container).appendTo(this.container);var e=this;var d=null;a(window).resize(function(){if(d){window.window.clearTimeout(d)}d=window.window.setTimeout(function(){e.repositionScaleControls(this.container)},200)});window.window.setTimeout(function(){e.repositionScaleControls(this.container)},200)};this.init(this.container,c)};a.fn.calendarFlow=function(b){var c=a.extend({dayWidth:150,dayHeight:1440,preLoadSize:2000,findEventsCallback:function(){return[]},moveEventCallback:function(){return[]}},b);this.each(function(){this.calendarFlow=new a.calendarFlow.Calendar(a(this),c)});return this}})(jQuery);