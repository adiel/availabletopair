(function(a){jQuery.calendarFlow={};jQuery.calendarFlow.datetime={dayName:function(b){switch(b.getUTCDay()){case (0):return"Sun";case (1):return"Mon";case (2):return"Tue";case (3):return"Wed";case (4):return"Thu";case (5):return"Fri";case (6):return"Sat"}},getMinutesThroughTheDay:function(b){return(b.getUTCHours()*60)+b.getUTCMinutes()},addDays:function(d,c){var b=new Date(d);b.setDate(d.getDate()+c);return b},addMins:function(d,c){var b=new Date(d);b.setMinutes(d.getMinutes()+c);return b},setTimeToMidnight:function(b){b.setHours(0);b.setMinutes(0);b.setSeconds(0)},formatDateForClassName:function(b){return b.getUTCFullYear()+"-"+b.getUTCMonth()+"-"+b.getUTCDate()},formatDateForDisplay:function(b){return b.toUTCString()},dayClass:function(b){return"cal-flow-"+this.dayName(b).toLowerCase()},dateOnly:function(b){return b.toString().replace(/[0-9][0-9]:[0-9][0-9]:[0-9][0-9]/,"").replace(/\+[0-9][0-9][0-9][0-9]/,"").replace(/\(.*\)/,"").replace(/GMT|UTC/,"")}};jQuery.calendarFlow.positioning={getCSSTop:function(b){return b.css("top").replace(/px/,"")},tooFarLeft:function(c,b,d){return((c.offset().left-b.offset().left)<(-1*d))},tooFarRight:function(d,b,e){var c=b.width();return(d.offset().left>c+e)},tooHigh:function(c,e){var d=this.getCSSTop(a(".cal-flow-events",c));var f=(c.height()/2);var b=-e;return d>b+f},tooLow:function(b,d){var c=this.getCSSTop(a(".cal-flow-events",b));var e=(b.height()/2);var f=(-d*2);return c<f+e}};jQuery.calendarFlow.eventRenderer={datetime:jQuery.calendarFlow.datetime,eventSummary:function(b){return b.title+" from "+this.datetime.formatDateForDisplay(b.start_time)+" - "+this.datetime.formatDateForDisplay(b.end_time)},updateDayTotal:function(e,c,g){var d=a(".cal-flow-dayHeader_"+this.datetime.formatDateForClassName(e.start_time),c);var b=a("span",d);var f=Number(b.text())+g;b.text(f);if(f>0){d.css("font-weight","bold")}},removeExistingEvent:function(e,c,b){var d=a("."+this.buildEventClassName(e,c),b);d.remove();if(d.length>0&&c===0){this.updateDayTotal(e,b,-1)}},plotEventStartTime:function(d,b,c){var e=Math.floor(this.datetime.getMinutesThroughTheDay(d)*(c/1440))+c;return e-(b*c)},getEventLengthMins:function(d,c){var b=this.datetime.getMinutesThroughTheDay(c)-this.datetime.getMinutesThroughTheDay(d);if(b<0){b+=1440}return b},buildEventClassName:function(c,b){return"cal-flow-event_"+b+"_"+c.id},isOverflowing:function(c){var b=c.style.overflow;if(!b||b==="visible"){c.style.overflow="hidden"}var d=c.clientWidth<c.scrollWidth||c.clientHeight<c.scrollHeight;c.style.overflow=b;return d},buildEventElement:function(d,n,g,l,m,b,j,i){var k=a("<div/>");k.attr("class","cal-flow-event "+this.buildEventClassName(d,n));var e=Math.floor(i/b);var f=(e*j);k.css({position:"absolute",top:l+"px",left:f+"px",height:m+"px",width:(e-1)+"px"});var h=a("<h3/>");h.html(d.title);k.append(h);var c=a('<div class="cal-flow-summary">');c.html(d.summary);k.append(c);return k},addEventTooltip:function(b){if(this.isOverflowing(b[0])){b.qtip({content:b.html(),position:{target:"mouse",adjust:{x:20,y:20}},hide:{fixed:true},style:{padding:"0"}})}},dropEvent:function(d,m,g,k,i,b,f){var e=m.position();var h=Math.floor((e.left-g.left)/k);var l=Math.floor(((e.top-g.top)/i)*1440);var c=this.datetime.addDays(d.start_time,h);d.start_time=this.datetime.addMins(c,l);var j=this.datetime.addDays(d.end_time,h);d.end_time=this.datetime.addMins(j,l);this.renderEvents([{event:d}],b,i,k,f);f(d)},makeEventDraggable:function(b,j,i,g,c,e){var f=j.position();var d=b;var h=this;j.draggable({grid:[i,Math.floor((g/1440)*30)],stop:function(k,l){h.dropEvent(d,j,f,i,g,c,e)},cursor:"move"})},renderEvent:function(b,q,c,h,j,p,f){this.removeExistingEvent(b,q,c);var i=this;var n=0;var k=0;a.each(p,function(r){if(this.start_time<b.end_time&&this.end_time>b.start_time){n++;if(this.id==b.id){k=n-1}}});var d=b.start_time;var g=b.end_time;d=this.datetime.addDays(d,q);var m=this.plotEventStartTime(d,q,h);var o=Math.floor(this.getEventLengthMins(d,g)*(h/1440));var e=a(".cal-flow-dayEvents_"+this.datetime.formatDateForClassName(d),c);var l=this.buildEventElement(b,q,e,m,o,n,k,j);e.prepend(l);this.addEventTooltip(l)},saveEvents:function(b){this.events=this.events||{};var c=this;a.each(b,function(){c.events[this.event.id]=this.event})},renderEvents:function(d,b,c,f,g){this.saveEvents(d);var e=this;jQuery.each(d,function(){e.renderEvent(this.event,-1,b,c,f,e.events,g);e.renderEvent(this.event,0,b,c,f,e.events,g);e.renderEvent(this.event,1,b,c,f,e.events,g);e.renderEvent(this.event,2,b,c,f,e.events,g);e.updateDayTotal(this.event,b,1)})}};jQuery.calendarFlow.Calendar=function(b,d){this.container=b;this.settings=d;this.dayHeightOptions=[336,720,1440];this.visibleEventsReloadTimeoutMS=60000;this.datetime=jQuery.calendarFlow.datetime;this.positioning=jQuery.calendarFlow.positioning;this.eventRenderer=jQuery.calendarFlow.eventRenderer;this.renderEvents=function(e){this.eventRenderer.renderEvents(e,this.container,this.settings.dayHeight,this.settings.dayWidth,this.settings.moveEventCallback)};this.loadEventsRange=function(f,e){this.settings.findEventsCallback(f,e,this)};this.newDayHeader=function(f){var e=f.getDate();if(this.settings.dayWidth>30){e=(f.getMonth()+1)+"/"+e;if(this.settings.dayWidth>70){e=f.toString().substring(0,3)+" "+e;if(this.settings.dayWidth>150){e=this.datetime.dateOnly(f)}}}var g=a('<div class="cal-flow-dayHeader  cal-flow-dayHeader_'+this.datetime.formatDateForClassName(f)+" "+this.datetime.dayClass(f)+'"><abbr title="'+this.datetime.dateOnly(f)+'">'+e+"</abbr> (<span>0</span>)</div>");g.css("width",this.settings.dayWidth+"px");return g};this.newDayEvents=function(f){var h=a('<div class="cal-flow-day '+this.datetime.dayClass(f)+" cal-flow-dayEvents_"+this.datetime.formatDateForClassName(f)+" cal-flow-date_"+f.getUTCDate()+'"></div>');h.css("width",(this.settings.dayWidth-1)+"px");var e=Math.floor(this.settings.dayHeight/24);var g={height:this.settings.dayHeight+"px","background-image":"url(/calendarflow/events_bg_"+e+".gif)"};a('<div class="cal-flow-prevDay"/>').css(g).appendTo(h);a('<div class="cal-flow-currentDay"/>').css(g).appendTo(h);a('<div class="cal-flow-nextDay"/>').css(g).appendTo(h);return h};this.readDateFromDayHeader=function(g){var e=Date.parse(a("abbr",g).attr("title"));var f=new Date(e);this.datetime.setTimeToMidnight(f);f.setMinutes(f.getMinutes()-f.getTimezoneOffset());return f};this.readHoursFromTimeHeader=function(e){return Number(a(e).text().substring(0,2))};this.readMinsFromTimeHeader=function(e){return Number(a(e).text().substring(3,5))};this.readOffsetFromTimeHeader=function(e){if(a(e).hasClass("offset_-1")){return -1}else{if(a(e).hasClass("offset_1")){return 1}else{return 0}}};this.positionNextDayElements=function(e,f,h){var i=Number(e.css("left").replace(/px/,""));var g=(i+this.settings.dayWidth)+"px";a(f).css("left",g);a(h).css("left",g)};this.positionPreviousDayElements=function(i,e,g){var h=Number(i.css("left").replace(/px/,""));var f=(h-this.settings.dayWidth)+"px";a(e).css("left",f);a(g).css("left",f)};this.newDayAhead=function(l,e,k,f){l.remove();e.remove();var h=this.readDateFromDayHeader(k);var j=this.datetime.addDays(h,1);var g=this.newDayHeader(j).appendTo(a(".cal-flow-dayHeaders",this.container));var i=this.newDayEvents(j).appendTo(a(".cal-flow-events",this.container));this.positionNextDayElements(f,g,i);return j};this.newDayBehind=function(l,e,j,f){f.remove();j.remove();var k=this.readDateFromDayHeader(e);var h=this.datetime.addDays(k,-1);var g=this.newDayHeader(h).prependTo(a(".cal-flow-dayHeaders",this.container));var i=this.newDayEvents(h).prependTo(a(".cal-flow-events",this.container));this.positionPreviousDayElements(l,g,i);return h};this.drawInitialDays=function(){var e,j,g,l,i,h,m;var k=Math.floor(this.settings.preLoadSize/this.settings.dayWidth)-2;var n=Math.floor(((this.container.width()/2)/this.settings.dayWidth))-1;var f=this.datetime.addDays(this.currentPosition,-n);e=0-k;do{j=this.datetime.setTimeToMidnight(new Date(f));j=this.datetime.addDays(f,e);h=h||j;m=j;g=this.newDayHeader(j);l=this.newDayEvents(j);i=(this.settings.dayWidth*e)+"px";a(g).css("left",i);a(l).css("left",i);g.appendTo(a(".cal-flow-dayHeaders",this.container));l.appendTo(a(".cal-flow-events",this.container));e++}while(!this.positioning.tooFarLeft(l,this.container,this.settings.preLoadSize)&&!this.positioning.tooFarRight(l,this.container,this.settings.preLoadSize));this.loadEventsRange(h,m)};this.drawExtraDays=function(m,g){var i=this;var n=a(".cal-flow-events .cal-flow-day",this.container);var j=a(".cal-flow-dayHeaders .cal-flow-dayHeader",this.container);var e=a(n[0]);var l=a(n[n.length-1]);var f=a(j[0]);var h=a(j[j.length-1]);window.clearTimeout(this.redrawDaysTimeout);if(this.positioning.tooFarLeft(e,this.container,this.settings.preLoadSize)){var k=this.newDayAhead(e,f,h,l);m=m||k;g=k;window.setTimeout(function(){i.drawExtraDays(m,g)},10);return}else{if(this.positioning.tooFarRight(l,this.container,this.settings.preLoadSize)){var o=this.newDayBehind(e,f,h,l);g=g||o;m=o;window.setTimeout(function(){i.drawExtraDays(m,g)},10);return}}if(m&&g){this.loadEventsRange(m,g)}};this.drawTimeline=function(){var g,e;for(g=0;g<72;g++){var f=Math.floor(this.settings.dayHeight/24);if(f<15){if(g%2!==0){continue}else{f*=2}}e=(g%24);if(e<10){e=("0"+e)}var h="offset_"+(((g-e)/24)-1);var i=a('<div class="cal-flow-time '+h+'">'+e+":00</div>");i.css({height:f});a(".cal-flow-timeline",this.container).append(i)}};this.buildWidthScaleControl=function(){var e=this;var f=a("<div/>");f.slider({min:35,max:1000,value:this.settings.dayWidth,change:function(g,h){window.clearTimeout(e.setDayWidthTimeout);e.setDayWidthTimeout=window.setTimeout(function(){e.setDayWidth(Number(h.value),e.container)},500)}});return f};this.buildHeightScaleControl=function(){var f=this;var e=a("<div/>");e.slider({orientation:"vertical",step:1,min:0,max:2,value:a.inArray(this.settings.dayHeight,this.dayHeightOptions),change:function(g,h){window.clearTimeout(f.setDayHeightTimeout);f.setDayHeightTimeout=window.setTimeout(function(){f.setDayHeight(f.dayHeightOptions[Number(h.value)],f.container)},500)}});return e};this.wrapSlider=function(e){return a('<div class="cal-flow-controls"/>').append(e)};this.buildScaleControls=function(){var f=this.buildWidthScaleControl(this.container);var e=this.buildHeightScaleControl(this.container);return a([this.wrapSlider(f),this.wrapSlider(e)])};this.setScale=function(){a(".cal-flow-calendarEventsWrapper",this.container).css({top:"-"+((this.settings.dayHeight*3)+20)+"px"});a(".cal-flow-timeline, .cal-flow-events",this.container).css({height:(this.settings.dayHeight*3)+"px",top:"-"+(this.settings.dayHeight-20)+"px"})};this.repositionScaleControls=function(){a(".cal-flow-controls").css("top",(this.container.height()-120)+"px");a(".cal-flow-controls").css("display","block")};this.drawInnerContainers=function(){a(".cal-flow-daysWrapper,.cal-flow-timelineWrapper,.cal-flow-calendarEventsWrapper").remove();a('<div class="cal-flow-daysWrapper">    <div class="cal-flow-dayHeaders"></div></div><div class="cal-flow-timelineWrapper">   <div class="cal-flow-timeline"></div></div><div class="cal-flow-calendarEventsWrapper">    <div class="cal-flow-events"></div></div>').appendTo(this.container)};var c=function(f){var e=-1*(this.settings.dayHeight*((new Date().getHours()-2)/24));f(".cal-flow-events",this.container).css("top",e+"px");this.syncAxes()};this.refocusCurrentDay=function(){var e=a(".cal-flow-events",this.container);var g=Number(e.css("top").replace(/px/,""));var f=Number(e.css("left").replace(/px/,""));if(this.positioning.tooHigh(this.container,this.settings.dayHeight)){e.css("left",f+this.settings.dayWidth+"px");e.css("top",g-this.settings.dayHeight+"px");this.syncAxes()}else{if(this.positioning.tooLow(this.container,this.settings.dayHeight)){e.css("left",f-this.settings.dayWidth+"px");e.css("top",g+this.settings.dayHeight+"px");this.syncAxes()}}};this.syncAxes=function(){var f=Number(a(".cal-flow-events",this.container).css("top").replace(/px/,""));var e=Number(a(".cal-flow-events",this.container).css("left").replace(/px/,""));a(".cal-flow-timeline",this.container).css("top",f+"px");a(".cal-flow-dayHeaders",this.container).css("left",e+"px")};this.dragged=function(e,f){this.syncAxes()};this.updateCurrentPosition=function(){this.currentPosition=this.findCurrentPosition()};this.stopped=function(e,f){this.drawExtraDays();this.refocusCurrentDay();this.syncAxes();this.updateCurrentPosition()};this.activateDraggable=function(){var e=this;a(".cal-flow-events",this.container).draggable({drag:function(f,g){e.dragged(f,g)},stop:function(f,g){e.stopped(f,g)},cursor:"move"})};this.addRootClass=function(){this.container.addClass("cal-flow")};this.findCurrentPosition=function(){var h,f;var j=this;a(".cal-flow-dayHeader",this.container).each(function(){var m=(a(this).offset().left-j.container.offset().left);var l=j.container.width()/2;if(m<l&&(m+j.settings.dayWidth)>l){h=this;return false}});a(".cal-flow-time",this.container).each(function(){var m=(a(this).offset().top-j.container.offset().top);var l=j.container.height()/2;if(m<l&(m+j.settings.dayHeight)>l){f=this;return false}});var g=this.readDateFromDayHeader(h);var k=this.readOffsetFromTimeHeader(f);g=this.datetime.addDays(g,k);var e=this.readHoursFromTimeHeader(f);var i=this.readMinsFromTimeHeader(f);g.setHours(e,i);return g};this.setDayWidth=function(e){if(this.settings.dayWidth!=e){this.settings.dayWidth=e;this.reset()}};this.setDayHeight=function(e){if(this.settings.dayHeight!=e){this.settings.dayHeight=e;this.reset()}};this.startVisibleEventsReloadTimeout=function(){var e=this;this.visibleEventsReloadTimeout=window.setTimeout(function(){var g=a(".cal-flow-dayHeaders .cal-flow-dayHeader",this.container);var f=a(g[0]);var h=a(g[g.length-1]);var j=e.readDateFromDayHeader(f);var i=e.readDateFromDayHeader(h);e.loadEventsRange(j,i);e.startVisibleEventsReloadTimeout()},this.visibleEventsReloadTimeoutMS)};this.reset=function(){window.clearTimeout(this.visibleEventsReloadTimeout);this.addRootClass();this.drawInnerContainers();this.setScale();this.drawTimeline();this.drawInitialDays();this.updateCurrentPosition();this.focusCurrentTime(a);this.activateDraggable();this.repositionScaleControls();this.startVisibleEventsReloadTimeout()};this.init=function(){if(this.container.length===0){return}this.currentPosition=this.currentPosition||new Date();this.datetime.setTimeToMidnight(this.currentPosition);this.reset();this.buildScaleControls(this.container).appendTo(this.container);var f=this;var e=null;a(window).resize(function(){if(e){window.window.clearTimeout(e)}e=window.window.setTimeout(function(){f.repositionScaleControls(this.container)},200)});window.window.setTimeout(function(){f.repositionScaleControls(this.container)},200)};this.init(this.container,d)};a.fn.calendarFlow=function(b){var c=a.extend({dayWidth:150,dayHeight:1440,preLoadSize:2000,findEventsCallback:function(){return[]},moveEventCallback:function(){return[]}},b);this.each(function(){this.calendarFlow=new a.calendarFlow.Calendar(a(this),c)});return this}})(jQuery);